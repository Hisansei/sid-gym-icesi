<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8"/>
    <title th:text="${'Rutina: ' + routine.name}">Rutina</title>
    <style>
        .rows { margin-top: 12px; }
        .row { border: 1px solid #ccc; padding: 8px; margin-bottom: 6px; display: grid; grid-template-columns: 1fr repeat(4, 120px) 120px 32px; gap: 8px; align-items: center; }
        .row .drag { cursor: move; text-align: center; }
    </style>
</head>
<body>
<h1 th:text="${routine.name}">Rutina</h1>

<form th:action="@{'/mvc/routines/' + ${routine.id} + '/rename'}" method="post">
    <input type="text" name="name" th:value="${routine.name}" required/>
    <button type="submit">Renombrar</button>
</form>

<h3>Agregar ejercicio</h3>
<form th:action="@{'/mvc/routines/' + ${routine.id} + '/items/add'}" method="post">
    <select name="exerciseId" required>
        <option value="">-- Seleccionar --</option>
        <option th:each="e : ${exerciseOptions}" th:value="${e.id}" th:text="${e.name + ' (' + e.type + ')'}"></option>
    </select>
    <input type="number" name="sets" placeholder="Sets" min="1"/>
    <input type="number" name="reps" placeholder="Reps" min="1"/>
    <input type="number" name="durationSec" placeholder="Duración (s)" min="0"/>
    <input type="number" name="restSeconds" placeholder="Descanso (s)" min="0"/>
    <input type="text" name="notes" placeholder="Notas"/>
    <button type="submit">Agregar</button>
</form>

<h3>Ejercicios</h3>
<form th:action="@{'/mvc/routines/' + ${routine.id} + '/reorder'}" method="post" id="reorderForm">
    <div id="rows" class="rows">
        <div th:each="it : ${routine.exercises}" class="row" draggable="true" ondragstart="drag(event)" ondragover="allowDrop(event)" ondrop="drop(event)" th:attr="data-id=${it.id}">
            <div class="drag">☰</div>

            <div>
                <b th:text="${exerciseMap.containsKey(it.exerciseId) ? exerciseMap.get(it.exerciseId).name : it.exerciseId}">Nombre</b>
                <div>
                    <small th:text="${exerciseMap.containsKey(it.exerciseId) ? exerciseMap.get(it.exerciseId).type : '-'}">Tipo</small>
                </div>
            </div>

            <div>
                <label>Sets</label>
                <span th:text="${it.sets}">3</span>
            </div>

            <div>
                <label>Reps</label>
                <span th:text="${it.reps}">10</span>
            </div>

            <div>
                <label>Duración (s)</label>
                <span th:text="${it.durationSeconds}">0</span>
            </div>

            <div>
                <label>Descanso (s)</label>
                <span th:text="${it.restSeconds}">60</span>
            </div>

            <form th:action="@{'/mvc/routines/' + ${routine.id} + '/items/' + ${it.id} + '/delete'}" method="post" style="display:inline">
                <button type="submit">Quitar</button>
            </form>
        </div>
    </div>

    <div id="orderHiddenInputs"></div>
    <button type="button" onclick="submitReorder()">Guardar orden</button>
</form>

<p><a th:href="@{/mvc/routines}">Volver</a></p>

<script>
    let dragEl;

    function drag(ev){ dragEl = ev.currentTarget; }
    function allowDrop(ev){ ev.preventDefault(); }
    function drop(ev){
        ev.preventDefault();
        const target = ev.currentTarget;
        const parent = document.getElementById('rows');
        if (dragEl && target && dragEl !== target) {
            parent.insertBefore(dragEl, target);
        }
    }

    function submitReorder(){
        const ids = Array.from(document.querySelectorAll('#rows .row')).map(r => r.getAttribute('data-id'));
        const hiddenContainer = document.getElementById('orderHiddenInputs');
        hiddenContainer.innerHTML = '';
        ids.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'order';
            input.value = id;
            hiddenContainer.appendChild(input);
        });
        document.getElementById('reorderForm').submit();
    }
</script>
</body>
</html>
