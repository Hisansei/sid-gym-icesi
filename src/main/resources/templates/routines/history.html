<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="'Histórico · ' + ${routine.name}">Histórico</title>
    <link rel="stylesheet" th:href="@{/css/app.css}">
</head>
<body>
<header class="container" style="display:flex;justify-content:space-between;align-items:center;gap:12px">
    <h1 th:text="'Histórico — ' + ${routine.name}">Histórico</h1>
    <nav>
        <a class="btn ghost" th:href="@{|/mvc/routines/${routine.id}|}">Volver a la rutina</a>
    </nav>
</header>

<main class="container">
    <section class="card">
        <form method="get" th:action="@{/mvc/progress/history}" class="grid grid-4">
            <input type="hidden" name="routineId" th:value="${routine.id}">
            <div class="field">
                <label>Desde</label>
                <input type="date" name="from" th:value="${from}">
            </div>
            <div class="field">
                <label>Hasta</label>
                <input type="date" name="to" th:value="${to}">
            </div>
            <div class="field col-span-2" style="display:flex;align-items:end">
                <button class="btn">Filtrar</button>
            </div>
        </form>
    </section>

    <section class="card">
        <h2>Sesiones</h2>
        <table class="table">
            <thead>
            <tr>
                <th>Fecha</th>
                <th># ejercicios</th>
                <th>RPE prom.</th>
                <th>Detalle</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="log : ${logs}">
                <td th:text="${#temporals.format(log.date, 'yyyy-MM-dd')}">-</td>

                <td th:text="${log.entries == null ? 0 : #lists.size(log.entries)}">0</td>

                <td th:with="vals=${log.entries.?[effortLevel != null].![T(java.lang.Integer).parseInt(effortLevel)]}"
                    th:text="${#lists.isEmpty(vals) ? '-' : #numbers.formatDecimal(#aggregates.avg(vals),1,1)}">-</td>

                    <details>
                        <summary>Ver</summary>
                        <ul>
                            <li th:each="e : ${log.entries}">
                                <span th:text="${e.exerciseId}">id</span> ·
                                <span th:if="${e.completed != null}">ok</span>
                                <span th:if="${e.sets != null}"> · sets: <b th:text="${e.sets}">-</b></span>
                                <span th:if="${e.reps != null}"> · reps: <b th:text="${e.reps}">-</b></span>
                                <span th:if="${e.completedDurationSec != null}"> · t: <b th:text="${e.completedDurationSec}">-</b>s</span>
                                <span th:if="${e.effortLevel != null}"> · RPE: <b th:text="${e.effortLevel}">-</b></span>
                                <span th:if="${e.notesUser != null}"> · <i th:text="${e.notesUser}">nota</i></span>
                            </li>
                        </ul>
                    </details>
                </td>
            </tr>
            <tr th:if="${#lists.isEmpty(logs)}">
                <td colspan="4" class="muted">No hay registros en el rango seleccionado.</td>
            </tr>
            </tbody>
        </table>
    </section>
</main>
</body>
</html>
