<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{components/base :: page(
          title=${template.id} != null ? 'Editar plantilla' : 'Nueva plantilla',
          content=~{::content}
      )}">
<section th:fragment="content">
  <link rel="stylesheet" th:href="@{/css/app.css}">
  <header class="site-header">
    <div class="container actions">
      <h1 class="page-title" th:text="${template.id} != null ? 'Editar plantilla' : 'Nueva plantilla'">Plantilla</h1>
      <a class="btn" th:href="@{/mvc/routine-templates}">Volver</a>
    </div>
  </header>

  <main class="container space-y card">
    <form th:action="${template.id} != null ? @{/mvc/routine-templates/{id}/edit(id=${template.id})} : @{/mvc/routine-templates/create}"
          method="post" class="form">

      <div class="grid grid-2">
        <label>Nombre
          <input type="text" name="name" th:value="${template.name}" required/>
        </label>
        <label>Nivel
          <select name="level">
            <option th:selected="${template.level=='BEGINNER'}" value="BEGINNER">BEGINNER</option>
            <option th:selected="${template.level=='INTERMEDIATE'}" value="INTERMEDIATE">INTERMEDIATE</option>
            <option th:selected="${template.level=='ADVANCED'}" value="ADVANCED">ADVANCED</option>
          </select>
        </label>
        <label>Entrenador (ID)
          <input type="text" name="trainerId" th:value="${template.trainerId}" required/>
        </label>
        <label>Descripción
          <textarea name="description" th:text="${template.description}"></textarea>
        </label>
      </div>

      <h2>Ejercicios</h2>
      <table class="table compact">
        <thead>
        <tr><th>#</th><th>Ejercicio (catálogo)</th><th>Series</th><th>Reps</th><th>Descanso (s)</th><th></th></tr>
        </thead>
        <tbody id="rows">
        <tr th:if="${#lists.isEmpty(template.exercises)}" class="muted">
          <td colspan="6">Sin filas todavía. Usa “Agregar fila”.</td>
        </tr>

        <tr th:each="it,idx : ${template.exercises}">
          <td><input type="number" min="0" th:name="${'exercises['+idx.index+'].order'}" th:value="${it.order}"/></td>
          <td>
            <select th:name="${'exercises['+idx.index+'].exerciseId'}">
              <option th:each="ex : ${exercises}" th:value="${ex.id}" th:selected="${ex.id==it.exerciseId}"
                      th:text="${ex.name}">Ejercicio</option>
            </select>
          </td>
          <td><input type="number" min="0" th:name="${'exercises['+idx.index+'].sets'}" th:value="${it.sets}"/></td>
          <td><input type="number" min="0" th:name="${'exercises['+idx.index+'].reps'}" th:value="${it.reps}"/></td>
          <td><input type="number" min="0" th:name="${'exercises['+idx.index+'].restSeconds'}" th:value="${it.restSeconds}"/></td>
          <td class="table-actions">
            <button class="btn btn-small" type="button" onclick="move(this,-1)">↑</button>
            <button class="btn btn-small" type="button" onclick="move(this,1)">↓</button>
            <button class="btn btn-small btn-danger" type="button" onclick="removeRow(this)">Quitar</button>
          </td>
        </tr>
        </tbody>
      </table>

      <div class="form-actions">
        <button class="btn" type="button" onclick="addRow()">Agregar fila</button>
        <button class="btn" type="submit" onclick="renumber()">Guardar</button>
      </div>
    </form>
  </main>
</section>

<script>
  function addRow(){
    const tbody = document.getElementById('rows');
    // quita fila “Sin filas…”
    tbody.querySelectorAll('.muted')?.forEach(m => m.remove());
    const idx = tbody.querySelectorAll('tr').length;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="number" min="0" name="exercises[${idx}].order" value="${idx+1}"/></td>
      <td>
        <select name="exercises[${idx}].exerciseId">
          ${Array.from(document.querySelectorAll('select[name$=".exerciseId"]:first-child option')).map(o => o.outerHTML).join('')}
        </select>
      </td>
      <td><input type="number" min="0" name="exercises[${idx}].sets"/></td>
      <td><input type="number" min="0" name="exercises[${idx}].reps"/></td>
      <td><input type="number" min="0" name="exercises[${idx}].restSeconds"/></td>
      <td class="table-actions">
        <button class="btn btn-small" type="button" onclick="move(this,-1)">↑</button>
        <button class="btn btn-small" type="button" onclick="move(this,1)">↓</button>
        <button class="btn btn-small btn-danger" type="button" onclick="removeRow(this)">Quitar</button>
      </td>`;
    tbody.appendChild(tr);
  }
  function removeRow(btn){
    const tr = btn.closest('tr'); tr.remove(); renumber();
  }
  function renumber(){
    const rows = Array.from(document.querySelectorAll('#rows tr'));
    rows.forEach((tr,i) => {
      tr.querySelectorAll('input,select').forEach(el => {
        el.name = el.name.replace(/exercises\[\d+]/,'exercises['+i+']');
      });
      const order = tr.querySelector('input[name$=".order"]');
      if(order) order.value = i+1;
    });
  }
  function move(btn,delta){
    const tr = btn.closest('tr'); const tbody = tr.parentElement;
    const rows = Array.from(tbody.children); const i = rows.indexOf(tr);
    const j = i + delta; if(j<0 || j>=rows.length) return;
    if(delta<0) tbody.insertBefore(tr, rows[j]); else tbody.insertBefore(rows[j], tr);
    renumber();
  }
</script>
</html>
