<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{components/base :: page(
              title='Nueva rutina',
              content=~{::content}
          )}">
<section th:fragment="content" class="routine-page routine-create-page">
    <link rel="stylesheet" th:href="@{/css/app.css}">
    <link rel="stylesheet" th:href="@{/css/routine/routine.css}">

    <header class="site-header">
        <div class="container actions routine-header">
            <div class="routine-header-main">
                <h1 class="page-title">Crear rutina</h1>
                <p class="muted routine-header-subtitle">
                    Selecciona ejercicios del catálogo del gimnasio ICESI y arma una rutina a tu medida.
                </p>
            </div>
            <nav class="actions">
                <a class="btn btn-ghost" th:href="@{/mvc/routines}">Volver a mis rutinas</a>
            </nav>
        </div>
    </header>

    <main class="container space-y card routine-card">
        <form class="form" th:action="@{/mvc/routines/create}" method="post">
            <section class="space-y">
                <div class="grid grid-2 routine-name-row">
                    <label>Nombre de la rutina
                        <input type="text" name="name" placeholder="Mi rutina personalizada" required>
                    </label>
                    <p class="muted small routine-name-hint">
                        Puedes cambiar el nombre más adelante desde el detalle de la rutina.
                    </p>
                </div>
            </section>

            <section class="space-y routine-exercise-selector">
                <div class="grid grid-2 routine-search-row">
                    <label class="routine-search-label">
                        Buscar ejercicio
                        <input id="search" type="text" placeholder="Filtra por nombre o tipo.">
                    </label>
                    <div class="form-actions routine-checkall">
                        <label class="routine-checkall-label">
                            <input id="checkAll" type="checkbox"> Seleccionar todos los visibles
                        </label>
                    </div>
                </div>

                <div class="card routine-table-card">
                    <header class="routine-card-subheader">
                        <h2>Catálogo de ejercicios</h2>
                        <p class="muted small">
                            Marca los ejercicios que quieres incluir en la nueva rutina.
                        </p>
                    </header>

                    <div class="table-wrapper">
                        <table class="table routine-table" id="exerciseTable">
                            <thead>
                            <tr>
                                <th></th>
                                <th>Nombre</th>
                                <th>Tipo</th>
                                <th>Duración</th>
                                <th>Dificultad</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:if="${#lists.isEmpty(exercises)}">
                                <td class="muted" colspan="5">No hay ejercicios disponibles.</td>
                            </tr>
                            <tr th:each="e : ${exercises}"
                                th:data-row="${e.id}"
                                th:data-name="${e.name}"
                                th:data-type="${e.type}">
                                <td>
                                    <input type="checkbox" name="exerciseIds" th:value="${e.id}"/>
                                </td>
                                <td th:text="${e.name}">Nombre</td>
                                <td th:text="${e.type}">Tipo</td>
                                <td th:text="${e.durationSeconds != null ? e.durationSeconds + ' s' : '—'}">—</td>
                                <td th:text="${e.difficulty}">—</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <div class="form-actions routine-create-actions">
                <button class="btn" type="submit">Crear rutina</button>
                <a class="btn btn-secondary" th:href="@{/mvc/routines}">Cancelar</a>
            </div>
        </form>
    </main>

    <script>
        // Búsqueda
        const q = document.getElementById('search');
        const rows = Array.from(document.querySelectorAll('tr[data-row]'));
        q?.addEventListener('input', () => {
            const term = q.value.trim().toLowerCase();
            rows.forEach(tr => {
                const name = (tr.dataset.name || '').toLowerCase();
                const type = (tr.dataset.type || '').toLowerCase();
                tr.style.display = (name.includes(term) || type.includes(term)) ? '' : 'none';
            });
        });

        // Seleccionar todos (solo filas visibles)
        const checkAll = document.getElementById('checkAll');
        checkAll?.addEventListener('change', (ev) => {
            const checked = ev.target.checked;
            rows.forEach(tr => {
                if (tr.style.display === 'none') return; // respeta filtro
                const cb = tr.querySelector('input[type="checkbox"]');
                if (cb) cb.checked = checked;
            });
        });
    </script>
</section>
</html>
