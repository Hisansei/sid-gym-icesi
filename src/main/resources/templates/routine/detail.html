<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{components/base :: page(
          title=${routine.name} != null ? ${routine.name} : 'Detalle de rutina',
          content=~{::content}
      )}">

<section th:fragment="content">
    <link rel="stylesheet" th:href="@{/css/app.css}"/>

    <header class="site-header">
        <div class="container actions">
            <h1 class="page-title">
                <span th:text="${routine.name}">Rutina</span>
            </h1>
            <nav class="actions">
                <a class="btn" th:href="@{/mvc/routines}">Volver</a>
                <a class="btn btn-secondary" th:href="@{'/mvc/progress/' + ${routine.id}}">Registrar progreso</a>
                <form th:action="@{'/mvc/routines/' + ${routine.id} + '/delete'}" method="post" style="display:inline"
                      onsubmit="return confirm('¿Eliminar esta rutina?');">
                    <button class="btn btn-danger" type="submit">Eliminar</button>
                </form>
            </nav>
        </div>
    </header>

    <main class="container space-y">
        <!-- Renombrar rutina -->
        <section class="card">
            <form class="form row" th:action="@{'/mvc/routines/' + ${routine.id} + '/rename'}" method="post">
                <label class="grow">Nombre de la rutina
                    <input type="text" name="name" th:value="${routine.name}" required/>
                </label>
                <button class="btn" type="submit">Guardar nombre</button>
            </form>
        </section>

        <section class="card">
            <h2>Agregar ejercicio</h2>
            <form class="form grid grid-2" th:action="@{'/mvc/routines/' + ${routine.id} + '/items/add'}" method="post">
                <label>Del catálogo
                    <select name="exerciseId">
                        <option value="">— Selecciona un ejercicio —</option>
                        <option th:each="ex : ${exerciseOptions}" th:value="${ex.id}" th:text="${ex.name}">Ejercicio</option>
                    </select>
                </label>

                <div class="muted" style="align-self:end">o ingresa uno personalizado</div>

                <label>Nombre personalizado
                    <input type="text" name="name" placeholder="p. ej. Caminata ligera"/>
                </label>

                <label>Series
                    <input type="number" name="sets" min="0" step="1" placeholder="p. ej. 3"/>
                </label>

                <label>Repeticiones
                    <input type="number" name="reps" min="0" step="1" placeholder="p. ej. 12"/>
                </label>

                <label>Duración (seg)
                    <!-- OJO: el controlador espera durationSec -->
                    <input type="number" name="durationSec" min="0" step="1" placeholder="p. ej. 60"/>
                </label>

                <label>Descanso (seg)
                    <input type="number" name="restSeconds" min="0" step="1" placeholder="p. ej. 60"/>
                </label>

                <div class="col-span-2">
                    <button class="btn" type="submit">Agregar</button>
                    <p class="muted" style="margin-top:.5rem">
                        Si eliges un ejercicio del catálogo, el nombre personalizado se ignora. Si lo dejas en blanco, puedes crear
                        un ejercicio personalizado con su nombre.
                    </p>
                </div>
            </form>
        </section>

        <!-- Lista + Reordenar ejercicios -->
        <section class="card">
            <div class="actions" style="display:flex;justify-content:space-between;align-items:center;">
                <h2>Ejercicios de la rutina</h2>
                <div>
                    <button class="btn btn-small" type="button" onclick="moveSelected(-1)">Subir</button>
                    <button class="btn btn-small" type="button" onclick="moveSelected(1)">Bajar</button>
                    <button class="btn" type="button" onclick="submitOrder()">Guardar orden</button>
                </div>
            </div>

            <!-- Form para enviar el orden al endpoint /reorder -->
            <form id="reorderForm" th:action="@{'/mvc/routines/' + ${routine.id} + '/reorder'}" method="post"></form>

            <table class="table" id="itemsTable">
                <thead>
                <tr>
                    <th>#</th>
                    <th>Ejercicio</th>
                    <th>Series</th>
                    <th>Reps</th>
                    <th>Duración (s)</th>
                    <th>Descanso (s)</th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                <tr th:if="${#lists.isEmpty(routine.exercises)}">
                    <td class="muted" colspan="7">Aún no hay ejercicios. Agrega el primero arriba.</td>
                </tr>

                <tr th:each="it,idx : ${routine.exercises}"
                    th:data-id="${it.id}"
                    onclick="selectRow(this)"
                    style="cursor:pointer;">
                    <td th:text="${idx.index + 1}">1</td>

                    <td>
            <span th:if="${it.exerciseId != null}"
                  th:text="${(exerciseMap[it.exerciseId] != null ? exerciseMap[it.exerciseId].name : it.exerciseId)}">Nombre</span>
                        <span th:if="${it.exerciseId == null}"
                              th:text="${it.name}">Personalizado</span>
                    </td>

                    <td th:text="${it.sets}">0</td>
                    <td th:text="${it.reps}">0</td>
                    <td th:text="${it.durationSeconds}">0</td>
                    <td th:text="${it.restSeconds}">0</td>

                    <td class="table-actions">
                        <form th:action="@{'/mvc/routines/' + ${routine.id} + '/items/' + ${it.id} + '/delete'}"
                              method="post" style="display:inline"
                              onsubmit="return confirm('¿Quitar este ejercicio?');">
                            <button class="btn btn-small btn-danger" type="submit">Eliminar</button>
                        </form>
                    </td>
                </tr>
                </tbody>
            </table>
        </section>
    </main>

    <script>
        let selectedRow = null;

        function selectRow(tr) {
            if (selectedRow) selectedRow.classList.remove('selected');
            selectedRow = tr;
            selectedRow.classList.add('selected');
        }

        function moveSelected(delta) {
            if (!selectedRow) return;
            const tbody = selectedRow.parentElement;
            const rows = Array.from(tbody.children).filter(r => r.dataset.id); // ignora fila vacía
            const idx = rows.indexOf(selectedRow);
            const newIdx = idx + delta;
            if (newIdx < 0 || newIdx >= rows.length) return;
            if (delta < 0) {
                tbody.insertBefore(selectedRow, rows[newIdx]);
            } else {
                tbody.insertBefore(selectedRow, rows[newIdx].nextSibling);
            }
            renumber(tbody);
        }

        function renumber(tbody) {
            Array.from(tbody.children)
                .filter(r => r.dataset.id)
                .forEach((r, i) => r.children[0].innerText = i + 1);
        }

        // Envía el orden actual como múltiples parámetros "order"
        function submitOrder() {
            const tbody = document.getElementById('itemsTable').querySelector('tbody');
            const ids = Array.from(tbody.children)
                .filter(r => r.dataset.id)
                .map(r => r.dataset.id);

            const form = document.getElementById('reorderForm');
            form.innerHTML = '';
            ids.forEach(id => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'order';
                input.value = id;
                form.appendChild(input);
            });
            form.submit();
        }
    </script>
</section>
</html>
